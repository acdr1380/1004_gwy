<div class="layout" [class.full_screen]="isFullScreen">
    <div class="header">
        <ng-container *ngIf="canEdit">
            <button nz-button nzType="primary" (click)="personSelectIfy.evtSelectPerson()">
                选择人员
            </button>

            <button [style.marginLeft.px]="10" nz-button nzType="primary">批量办理</button>
        </ng-container>

        <div class="right">
            <button
                nz-button
                nzType="link"
                nz-tooltip
                nzTooltipTitle="流程图"
                (click)="flowChart.open()"
            >
                <i nz-icon nzType="cluster"></i>
            </button>
            <button
                nz-button
                nzType="link"
                nz-tooltip
                nzTooltipTitle="流程跟踪"
                (click)="tailAfterOper.open()"
            >
                <i nz-icon nzType="deployment-unit"></i>
            </button>
            <button
                nz-button
                nzType="link"
                nz-tooltip
                nzTooltipTitle="全屏"
                (click)="fullScreenSwith()"
            >
                <i nz-icon nzType="fullscreen"></i>
            </button>
        </div>
    </div>
    <div class="container" #personTableElement>
        <div class="view tbl"></div>
    </div>
</div>

<!-- 业务流程图 -->
<nz-drawer
    nzPlacement="top"
    [nzVisible]="flowChart.visible"
    [nzTitle]="flowChart.title"
    [nzHeight]="flowChart.height"
    (nzOnClose)="flowChart.close()"
>
    <div class="drawer_area oper_step_flow">
        <nz-steps [nzCurrent]="flowChart.evtGetStepIndex()">
            <ng-container *ngFor="let item of flowChart.operStepList">
                <nz-step
                    [nzTitle]="item.stepName"
                    [nzIcon]="item.icon"
                    [nzDescription]="item.desc || ''"
                >
                </nz-step>
            </ng-container>
        </nz-steps>
    </div>
</nz-drawer>

<!-- 办理历史 -->
<nz-drawer
    [nzVisible]="tailAfterOper.visible"
    [nzTitle]="tailAfterOper.title"
    [nzWidth]="tailAfterOper.width"
    (nzOnClose)="tailAfterOper.close()"
>
    <div class="drawer_area oper_tail">
        <div class="container">
            <nz-timeline>
                <nz-timeline-item [nzDot]="dotTemplate"><span>业务开始</span></nz-timeline-item>
                <ng-container *ngFor="let item of tailAfterOper.tailAfterList; let i = index">
                    <nz-timeline-item [nzColor]="['red', 'blue', 'green'][i % 3]">
                        <p>
                            <b>{{ item.stateDesc }}</b>
                            {{ item.auditDate | date: 'yyyy-MM-dd HH:mm' }}
                        </p>
                        <p>
                            <b
                                ><span>{{ item.contacts }}</span></b
                            ><span> {{ item.orgName }} {{ item.contactNumber }}</span>
                        </p>
                        <p *ngIf="item.auditStateDesc">批复结果： {{ item.auditStateDesc }}</p>
                    </nz-timeline-item>
                </ng-container>
            </nz-timeline>
            <ng-template #dotTemplate>
                <i nz-icon type="clock-circle-o" style="font-size: 16px"></i>
            </ng-template>
        </div>
    </div>
</nz-drawer>

<!-- 选择人员 -->
<oper-select-person
    #operSelectPerson
    [jobStepInfo]="jobStepInfo"
    [filterParmas]="personSelectIfy.filterParmas"
    (selectedChange)="personSelectIfy.evtChange()"
    [disabledList]="personSelectIfy.psnKeyIds"
></oper-select-person>

<!-- 校验信息 -->
<nz-drawer
    [nzClosable]="true"
    [nzVisible]="dataVerificationIfy.visible"
    nzPlacement="right"
    nzTitle="校验信息"
    [nzWidth]="dataVerificationIfy.width"
    (nzOnClose)="dataVerificationIfy.close()"
>
    <div class="drawer_area">
        <nz-table
            nzBordered
            nzSize="small"
            #dataVerificationTblElement
            [nzData]="dataVerificationIfy.list"
        >
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>错误信息</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let data of dataVerificationTblElement.data">
                    <td>{{ data.keyName }}</td>
                    <td>{{ data.result }}</td>
                </tr>
            </tbody>
        </nz-table>
    </div>
</nz-drawer>

<!-- 构造编辑字段 -->
<ng-template
    #inputEditElement
    let-formGroup="formGroup"
    let-fields="fields"
    let-formData="formData"
>
    <form nz-form [formGroup]="formGroup" nzLayout="vertical">
        <ng-container *ngFor="let field of fields">
            <nz-form-item *ngIf="!field.visible">
                <nz-form-label [nzRequired]="field.SCHEME_EDIT_IS_MUST_INPUT">
                    {{ field.SCHEME_EDIT_DISPLAY_NAME }}
                </nz-form-label>

                <nz-form-control [nzErrorTip]="errorTpl">
                    <ng-container *ngIf="field.TABLE_COLUMN_DICTIONARY_CODE; else elseTempElement">
                        <dictionary-input
                            [code]="field.TABLE_COLUMN_DICTIONARY_CODE"
                            [(text)]="formData[field.TABLE_COLUMN_CODE + '_CN']"
                            [placeholder]="'请填写' + field.SCHEME_EDIT_DISPLAY_NAME"
                            [formControlName]="field.TABLE_COLUMN_CODE"
                        >
                        </dictionary-input>
                    </ng-container>

                    <ng-template #elseTempElement>
                        <ng-container [ngSwitch]="field.TABLE_COLUMN_TYPE">
                            <ng-template [ngSwitchCase]="columnType.DATE">
                                <datetime-input
                                    [formControlName]="field.TABLE_COLUMN_CODE"
                                    [placeholder]="'请填写' + field.SCHEME_EDIT_DISPLAY_NAME"
                                ></datetime-input>
                            </ng-template>
                            <ng-template [ngSwitchCase]="columnType.NUMBER">
                                <nz-input-number
                                    [formControlName]="field.TABLE_COLUMN_CODE"
                                    [nzPlaceHolder]="'请填写' + field.SCHEME_EDIT_DISPLAY_NAME"
                                >
                                </nz-input-number>
                            </ng-template>
                            <ng-template [ngSwitchCase]="columnType.CLOB">
                                <textarea
                                    nz-input
                                    [formControlName]="field.TABLE_COLUMN_CODE"
                                    rows="4"
                                ></textarea>
                            </ng-template>
                            <ng-template ngSwitchDefault>
                                <input
                                    [formControlName]="field.TABLE_COLUMN_CODE"
                                    nz-input
                                    [placeholder]="'请填写' + field.SCHEME_EDIT_DISPLAY_NAME"
                                />
                            </ng-template>
                        </ng-container>
                    </ng-template>
                </nz-form-control>
                <ng-template #errorTpl let-control>
                    <ng-container *ngIf="control.hasError('required')">
                        请填写{{ field.FIELD_EDIT_DISPLAY_NAME }}。
                    </ng-container>
                    <ng-container *ngIf="control.hasError('msg')">
                        {{ control?.getError('msg') || '异常错误。' }}
                    </ng-container>
                </ng-template>
            </nz-form-item>
        </ng-container>
    </form>
</ng-template>
