import { HttpClient } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { CommonService } from 'app/util/common.service';
import { NzMessageService } from 'ng-zorro-antd/message';

import * as Mock from 'mockjs';
import { of } from 'rxjs';
import { map, filter, tap } from 'rxjs/operators';
import { R } from 'app/entity/vo/R';

@Injectable({
    providedIn: 'root',
})
export class IndexService {
    /**
     * 业务办理状态中文
     *
     * @export
     * @enum {number}
     */
    JobStepStateEnum_CN = {
        /**
         * 等待办理
         */
        0: '等待办理',
        /**
         * 草稿
         */
        1: '草稿',
        /**
         * 已申报
         */
        2: '已申报',
        /**
         * 审批通过
         */
        3: '审批通过',
        /**
         * 审批未通过，已退回"
         */
        4: '审批未通过，已退回',
        /**
         * 已作废
         */
        5: '已作废',
        /**
         * 已办结
         */
        6: '已办结',
    };

    constructor(
        private http: HttpClient,
        private message: NzMessageService,
        private commonService: CommonService
    ) {}

    /**
     * 获得业务统计状态列表
     *
     * @returns {Observable<any[]>} 业务统计状态列表
     * @memberof IndexService
     */
    getWfListInfo(): any[] {
        return [
            {
                text: '待处理',
                key: 'OPER_PENDING',
                icon: 'file-sync',
                desc: '',
                bgColor: 'linear-gradient(45deg,#4099ff,#73b4ff)',
                value: 1,
            },
            {
                text: '已提交',
                key: 'OPER_PROCESSING',
                icon: 'save',
                desc: '',
                bgColor: 'linear-gradient(45deg,#2ed8b6,#59e0c5)',
                value: 2,
            },
            {
                text: '已完成',
                key: 'OPER_DONE',
                icon: 'file-add',
                desc: '',
                bgColor: 'linear-gradient(45deg,#ffb64d,#ffcb80)',
                value: 3,
            },
            {
                text: '已作废',
                key: 'OPER_CANCEL',
                icon: 'delete',
                desc: '',
                bgColor: 'linear-gradient(45deg,#ff5370,#ff869a)',
                value: 4,
            },
        ];
    }

    /**
     * 获取业务列表
     */
    getWfList(state, { pageIndex, pageSize }) {
        const url = 'api/gl-1002-workflow-core/v1/workflow/workbench/info/getExcludingWfList';
        return this.http
            .post<R>(url, {
                state, // 状态 0 all 1待办 2正在办理 3已完成 4已作废
                pageIndex,
                pageSize,
                // wfIds: ['open_exam'],
            })
            .pipe(
                tap((json: R) => {
                    if (json.code !== 0) {
                        this.message.error(json.msg);
                    }
                }),
                filter(json => json.code === 0),
                map(json => json.data)
            );
    }

    /**
     * 获得业务步骤
     *
     * @param {*} wfId 业务编码
     */
    getOperStepList(wfId) {
        const stepDetail_url = 'api/gl-1002-workflow-core/v1/workflow/step/selectByWfId';
        return this.http.get<R>(`${stepDetail_url}/${wfId}`).pipe(
            tap((json: R) => {
                if (json.code !== 0) {
                    this.message.error(json.msg);
                }
            }),
            filter(json => json.code === 0),
            map(json => json.data)
        );
    }
    /**
     * 流程监控
     *
     * @param {string} jobId 业务编码
     * @returns {Observable<WfTrackingInfo>} 流程监控内容
     * @memberof PostInitialService
     */
    selectListByWfTracking(jobId: string) {
        const url = `api/gl-1002-workflow-core/v1/workflow/job/handle/selectListByWfTracking/${jobId}`;
        return this.http.get<R>(url).pipe(
            tap((json: R) => {
                if (json.code !== 0) {
                    this.message.error(json.msg);
                }
            }),
            filter(json => json.code === 0),
            map(json => json.data)
        );
    }

    /**
     * 业务办理记录查询
     */
    getRecordWfRemind() {
        const url = 'api/gl-1002-workflow-core/v1/workflow/workbench/info/getRecordWfRemind';
        return this.http.get<R>(url).pipe(
            tap((json: R) => {
                if (json.code !== 0) {
                    this.message.error(json.msg);
                }
            }),
            filter(json => json.code === 0),
            map(json => json.data)
        );
    }
}
