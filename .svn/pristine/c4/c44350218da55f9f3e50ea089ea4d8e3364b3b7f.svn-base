<div class="layout">
    <div class="header head-btn">
        <button nz-button (click)="addPsnDra.open()" [disabled]="!state.DB">
            <i nz-icon nzType="user-add" nzTheme="outline"></i>添加考核人员
        </button>
        <button nz-button (click)="batchTimeIfy.open()" [disabled]="!state.DB">
            <i nz-icon nzType="history" nzTheme="outline"></i>批量调整考核时间
        </button>
        <button nz-button (click)="batchResIfy.open()" [disabled]="!state.DB">
            <i nz-icon nzType="carry-out" nzTheme="outline"></i>批量修改考核结果
        </button>
    </div>
    <div class="header" *ngIf="tabars.list.length > 0">
        <nz-tabset
            [nzTabBarStyle]="{ 'margin.px': 0, 'height.px': 50 }"
            [(nzSelectedIndex)]="tabars.index"
            (nzSelectedIndexChange)="tabars.evtChange($event)"
        >
            <ng-container *ngFor="let item of tabars.list">
                <nz-tab [nzTitle]="item.text"></nz-tab>
            </ng-container>
        </nz-tabset>
    </div>
    <div class="container">
        <nz-table
            #pTable
            nzBordered="true"
            nzSize="small"
            [nzFrontPagination]="'false'"
            [(nzPageSize)]="psnTable.pageSize"
            [(nzPageIndex)]="psnTable.pageIndex"
            [nzData]="psnTable.rows"
            [ngStyle]="{ width: '100%' }"
            [nzFrontPagination]="'fasle'"
            [nzTotal]="psnTable.total"
            [nzLoading]="psnTable.loading"
            (nzPageIndexChange)="psnTable.evtIndexChange()"
        >
            <thead>
                <tr>
                    <th
                        nzWidth="40px"
                        nzShowCheckbox
                        [(nzChecked)]="psnTable.isAllCheck"
                        [nzIndeterminate]="psnTable.isIndeterminate"
                        (nzCheckedChange)="psnTable.checkAll($event)"
                    ></th>
                    <ng-container *ngFor="let item of psnTable.fields">
                        <th nzAlign="center">{{ item.itemName }}</th>
                    </ng-container>
                    <th nzWidth="110px" nzAlign="center" *ngIf="state.DB">操作</th>
                </tr>
            </thead>
            <tbody>
                <ng-container *ngFor="let row of pTable.data">
                    <tr>
                        <td
                            nzWidth="40px"
                            nzShowCheckbox
                            [(nzChecked)]="row['check']"
                            (nzCheckedChange)="psnTable.refreshStatus()"
                        ></td>
                        <ng-container *ngFor="let item of psnTable.fields">
                            <ng-container [ngSwitch]="item.columnType">
                                <ng-template ngSwitchCase="text">
                                    <td nzAlign="center">
                                        {{ row[item.itemId + '_CN'] || row[item.itemId] }}
                                    </td>
                                </ng-template>
                                <ng-template ngSwitchCase="select">
                                    <td>
                                        <nz-select
                                            style="width: 100%"
                                            [(ngModel)]="row[item.itemId]"
                                            (ngModelChange)="psnTable.examine($event, row)"
                                            [nzDisabled]="!state.DB"
                                        >
                                            <ng-container *ngFor="let opt of AssessStateEnum_CN">
                                                <nz-option
                                                    [nzLabel]="opt.text"
                                                    [nzValue]="opt.value"
                                                ></nz-option>
                                            </ng-container>
                                        </nz-select>
                                    </td>
                                </ng-template>
                            </ng-container>
                        </ng-container>
                        <td nzAlign="center" *ngIf="state.DB">
                            <a (click)="personEditIfy.open(row)">编辑</a>
                            <nz-divider nzType="vertical"></nz-divider>
                            <a (click)="psnTable.delete(row)">删除</a>
                        </td>
                    </tr>
                </ng-container>
            </tbody>
        </nz-table>
    </div>
</div>

<!-- 添加考核人员抽屉 -->
<nz-drawer
    [nzVisible]="addPsnDra.visible"
    [nzTitle]="addPsnDra.title"
    [nzWidth]="addPsnDra.width"
    (nzOnClose)="addPsnDra.close()"
>
    <div class="drawer_area">
        <div class="header">
            <nz-select
                nzPlaceHolder="输入姓名搜索"
                nzShowSearch
                [nzShowArrow]="false"
                [ngStyle]="{ 'width.px': 360 }"
                [(ngModel)]="addPsnDra.find.key"
                (ngModelChange)="addPsnDra.find.evtChange($event)"
                (nzOnSearch)="addPsnDra.find.evtOnSearch($event)"
                (nzOpenChange)="addPsnDra.find.evtOpenChange($event)"
            >
                <ng-container *ngFor="let item of addPsnDra.find.list">
                    <nz-option [nzLabel]="item.text" [nzValue]="item.value"></nz-option>
                </ng-container>
            </nz-select>
        </div>
        <div class="container">
            <div class="parent">
                <div class="child">
                    <nz-table
                        #selectTable
                        nzBordered="true"
                        nzSize="small"
                        [nzData]="addPsnDra.table.rows"
                        [(nzPageIndex)]="addPsnDra.table.pageIndex"
                        [nzFrontPagination]="false"
                        [nzTotal]="addPsnDra.table.total"
                        (nzPageIndexChange)="addPsnDra.table.evtIndexChange()"
                    >
                        <thead>
                            <tr>
                                <th
                                    nzShowCheckbox
                                    [(nzChecked)]="addPsnDra.isAllCheck"
                                    (nzCheckedChange)="addPsnDra.checkAll($event)"
                                    [nzIndeterminate]="addPsnDra.isIndeterminate"
                                ></th>
                                <th nzAlign="center">姓名</th>
                                <th nzAlign="center">性别</th>
                                <th nzAlign="center">年龄</th>
                                <th nzAlign="center">身份证号</th>
                            </tr>
                        </thead>
                        <tbody>
                            <ng-container
                                *ngFor="let item of selectTable.data; let rowIndex = index"
                            >
                                <tr
                                    [class.active]="addPsnDra.table.selectedRowIndex === rowIndex"
                                    (click)="addPsnDra.table.evtSelectorRow(rowIndex)"
                                >
                                    <td
                                        nzShowCheckbox
                                        [(nzChecked)]="item.check"
                                        (nzCheckedChange)="addPsnDra.refreshStatus()"
                                    ></td>
                                    <td nzAlign="center">{{ item.A0101 }}</td>
                                    <td nzAlign="center">{{ item.A0104_CN }}</td>
                                    <td nzAlign="center">{{ item.A0107A }}</td>
                                    <td nzAlign="center">{{ item.A0184 }}</td>
                                </tr>
                            </ng-container>
                        </tbody>
                    </nz-table>
                </div>
                <div class="child">
                    <ng-container *ngFor="let item of addPsnDra.selectPsnTags">
                        <nz-tag nzMode="closeable" (nzOnClose)="addPsnDra.removeTag(item)">{{
                            item.A0101
                        }}</nz-tag>
                    </ng-container>
                </div>
            </div>
        </div>
        <div class="footer">
            <button nz-button (click)="addPsnDra.close()">取消</button>
            <button nz-button nzType="primary" (click)="addPsnDra.evtImportPsn()">确定</button>
        </div>
    </div>
</nz-drawer>

<!-- 批量修改考核时间 -->
<nz-drawer
    [(nzVisible)]="batchTimeIfy.visible"
    [nzTitle]="batchTimeIfy.title"
    [nzWidth]="batchTimeIfy.width"
    (nzOnClose)="batchTimeIfy.close()"
>
    <div class="drawer_area">
        <div class="container">
            <form nz-form [formGroup]="batchTimeIfy.form">
                <nz-form-item>
                    <nz-form-label nzRequired>考试时间</nz-form-label>
                    <nz-form-control>
                        <nz-date-picker formControlName="A2501"></nz-date-picker>
                        <nz-form-explain
                            *ngIf="
                                batchTimeIfy.form.get('A2501')?.dirty &&
                                batchTimeIfy.form.get('A2501')?.errors
                            "
                        >
                            考试时间不能为空!
                        </nz-form-explain>
                    </nz-form-control>
                </nz-form-item>
            </form>
        </div>
        <div class="footer">
            <button nz-button (click)="batchTimeIfy.close()">取消</button>
            <button nz-button nzType="primary" (click)="batchTimeIfy.evtSave()">保存</button>
        </div>
    </div>
</nz-drawer>

<!-- 批量修改考核结果 -->
<nz-drawer
    [(nzVisible)]="batchResIfy.visible"
    [nzTitle]="batchResIfy.title"
    [nzWidth]="batchResIfy.width"
    (nzOnClose)="batchResIfy.close()"
>
    <div class="drawer_area">
        <div class="container">
            <form nz-form [formGroup]="batchResIfy.form">
                <nz-form-item>
                    <nz-form-label nzRequired>考核结果</nz-form-label>
                    <nz-form-control>
                        <dictionary-input
                            [code]="'CCC'"
                            [placeholder]="'请填写考核结果'"
                            formControlName="A2502"
                        >
                        </dictionary-input>
                        <nz-form-explain
                            *ngIf="
                                batchResIfy.form.get('A2502')?.dirty &&
                                batchResIfy.form.get('A2502')?.errors
                            "
                        >
                            考核结果不能为空!
                        </nz-form-explain>
                    </nz-form-control>
                </nz-form-item>
            </form>
        </div>
        <div class="footer">
            <button nz-button (click)="batchResIfy.close()">取消</button>
            <button nz-button nzType="primary" (click)="batchResIfy.evtSave()">保存</button>
        </div>
    </div>
</nz-drawer>

<!-- 人员编辑 -->
<nz-drawer
    [(nzVisible)]="personEditIfy.visible"
    [nzTitle]="personEditIfy.title"
    [nzWidth]="personEditIfy.width"
    (nzOnClose)="personEditIfy.close()"
>
    <div class="drawer_area">
        <div class="container">
            <form nz-form [formGroup]="personEditIfy.form">
                <ng-container *ngFor="let field of personEditIfy.fields">
                    <nz-form-item>
                        <nz-form-label [nzRequired]="field.SCHEME_EDIT_IS_MUST_INPUT">
                            {{ field.SCHEME_EDIT_DISPLAY_NAME }}
                        </nz-form-label>

                        <nz-form-control [nzErrorTip]="errorTpl">
                            <ng-container
                                *ngIf="field.TABLE_COLUMN_DICTIONARY_CODE; else elseTempElement"
                            >
                                <dictionary-input
                                    [code]="field.TABLE_COLUMN_DICTIONARY_CODE"
                                    [placeholder]="'请填写' + field.SCHEME_EDIT_DISPLAY_NAME"
                                    [formControlName]="field.TABLE_COLUMN_CODE"
                                >
                                </dictionary-input>
                            </ng-container>

                            <ng-template #elseTempElement>
                                <ng-container *ngIf="field.TABLE_COLUMN_TYPE === columnType.DATE">
                                    <nz-date-picker
                                        [formControlName]="field.TABLE_COLUMN_CODE"
                                        [nzPlaceHolder]="'请填写' + field.SCHEME_EDIT_DISPLAY_NAME"
                                    >
                                    </nz-date-picker>
                                </ng-container>
                                <ng-container
                                    *ngIf="field.TABLE_COLUMN_TYPE === columnType.VARCHAR"
                                >
                                    <input
                                        nz-input
                                        [formControlName]="field.TABLE_COLUMN_CODE"
                                        [placeholder]="'请填写' + field.SCHEME_EDIT_DISPLAY_NAME"
                                    />
                                </ng-container>
                                <ng-container *ngIf="field.TABLE_COLUMN_TYPE === columnType.NUMBER">
                                    <nz-input-number
                                        [ngStyle]="{ width: '100%' }"
                                        [formControlName]="field.TABLE_COLUMN_CODE"
                                        [nzPlaceHolder]="'请填写' + field.SCHEME_EDIT_DISPLAY_NAME"
                                    >
                                    </nz-input-number>
                                </ng-container>
                                <ng-container *ngIf="field.TABLE_COLUMN_TYPE === columnType.CLOB">
                                    <textarea
                                        nz-input
                                        [formControlName]="field.TABLE_COLUMN_CODE"
                                        rows="4"
                                    ></textarea>
                                </ng-container>
                            </ng-template>

                            <ng-template #errorTpl let-control>
                                <ng-container *ngIf="control.hasError('required')">
                                    请填写{{ field.FIELD_EDIT_DISPLAY_NAME }}。
                                </ng-container>
                                <ng-container *ngIf="control.hasError('msg')">
                                    {{ control?.getError('msg') || '异常错误。' }}
                                </ng-container>
                            </ng-template>
                        </nz-form-control>
                    </nz-form-item>
                </ng-container>
            </form>
        </div>
        <div class="footer">
            <button nz-button nzType="primary" (click)="personEditIfy.evtSave()">保存</button>
            <button nz-button (click)="personEditIfy.close()">取消</button>
        </div>
    </div>
</nz-drawer>
