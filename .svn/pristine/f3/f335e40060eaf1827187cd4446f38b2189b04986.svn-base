<div class="layout">
    <div class="container">
        <div class="left" style="width: 200px">
            <div class="find" [hidden]="!isUsable">
                <button
                    nz-button
                    nzType="primary"
                    (click)="personListIfy.evtAddPerson()"
                    style="width: 90%"
                >
                    选择人员
                </button>
            </div>

            <div class="find">
                <div class="left_btn">
                    <nz-select
                        nzShowSearch
                        nzServerSearch
                        nzAllowClear
                        [nzPlaceHolder]="personListIfy.find.placeholder || '请输入关键字搜索'"
                        [nzShowArrow]="false"
                        [nzFilterOption]="personListIfy.find.nzFilterOption"
                        [(ngModel)]="personListIfy.find.value"
                        (ngModelChange)="personListIfy.find.evtChange($event)"
                        (nzOnSearch)="personListIfy.find.evtSearch($event)"
                        (nzOpenChange)="personListIfy.find.evtOpenChange($event)"
                    >
                        <ng-container>
                            <nz-option
                                *ngFor="let item of personListIfy.find.list"
                                [nzLabel]="item.text"
                                [nzValue]="item.value"
                            >
                            </nz-option>
                        </ng-container>
                    </nz-select>
                </div>
            </div>
            <div class="tree">
                <cdk-virtual-scroll-viewport
                    #scrollViewPersonList
                    [itemSize]="40"
                    class="view_scroll audit_list"
                >
                    <ng-container *ngFor="let item of personListIfy.list; let i = index">
                        <div
                            class="item"
                            [class.active]="item === personListIfy.selectedPsnData"
                            (click)="personListIfy.evtSelectedPerson(item)"
                        >
                            <div class="title">{{ item.name }}</div>
                            <div class="btns" *ngIf="isUsable && jobStepInfo.stepId === 'start'">
                                <div
                                    class="btn danger"
                                    (click)="personListIfy.evtDeletePerson(item)"
                                >
                                    撤选
                                </div>
                            </div>
                        </div>
                    </ng-container>
                </cdk-virtual-scroll-viewport>
            </div>
        </div>
        <div class="right">
            <div class="layout">
                <div class="container">
                    <nz-spin class="spin" [nzSpinning]="psnSalaryInfoIfy.isSpinning">
                        <div class="spin">
                            <ng-template [ngTemplateOutlet]="personBaseInfoTemp"></ng-template>
                            <div class="view_mid"></div>
                            <ng-template [ngTemplateOutlet]="otherInfoTemplate"></ng-template>
                        </div>
                    </nz-spin>
                </div>
            </div>
        </div>
        <!-- 选择人员组件 -->
        <oper-select-person
            #operSelectPerson
            [jobStepInfo]="jobStepInfo"
            [disabledList]="personListIfy.evtDisabledPsn()"
            (selectedChange)="personListIfy.evtChange()"
        >
        </oper-select-person>
    </div>
</div>

<!-- 人员基本子集信息 -->
<ng-template #personBaseInfoTemp>
    <div class="base" [class.full_screen]="isUpFullScreen">
        <div class="layout">
            <div class="header tabset_header">
                <div>
                    <nz-radio-group
                        [(ngModel)]="psnBaseInfoIfy.TABLE_CODE"
                        (ngModelChange)="psnBaseInfoIfy.evtTabChange($event)"
                        nzButtonStyle="solid"
                    >
                        <ng-container *ngFor="let item of psnBaseInfoIfy.list">
                            <label nz-radio-button [nzValue]="item.TABLE_CODE">{{
                                item.TABLE_NAME
                            }}</label>
                        </ng-container>
                    </nz-radio-group>
                </div>

                <div class="tabset_extra">
                    <div class="arrows" (click)="evtUpDownArrows('up')">
                        <i class="fa fa-arrows-alt"></i>
                    </div>
                </div>

                <div
                    class="right"
                    *ngIf="
                        psnBaseInfoIfy.TABLE_CODE === 'GZ01' ||
                        psnBaseInfoIfy.TABLE_CODE === 'GZ02' ||
                        psnBaseInfoIfy.TABLE_CODE === 'GZ06' ||
                        psnBaseInfoIfy.TABLE_CODE === 'GZ09' ||
                        psnBaseInfoIfy.TABLE_CODE === 'GZ42'
                    "
                >
                    <button
                        [disabled]="!isUsable"
                        nz-button
                        nzType="primary"
                        (click)="psnBaseInfoIfy.evtAddPsnData()"
                    >
                        增加
                    </button>
                </div>
            </div>
            <div class="container">
                <ng-container *ngFor="let item of psnBaseInfoIfy.list">
                    <div
                        class="view_scroll view_table"
                        [hidden]="!(item.TABLE_CODE === psnBaseInfoIfy.TABLE_CODE)"
                    >
                        <ng-container *ngIf="item.TABLE_CODE !== 'person_file'; else elseTemplate">
                            <ng-template
                                [ngTemplateOutlet]="
                                    item.type === 'single' ? A01ChildTemp : tableChildTemp
                                "
                                [ngTemplateOutletContext]="{
                                    fields: item.fields,
                                    result: item.result
                                }"
                            ></ng-template>
                        </ng-container>
                        <ng-template #elseTemplate>
                            <ng-template [ngTemplateOutlet]="personFileTemp"></ng-template>
                        </ng-template>
                    </div>
                </ng-container>
            </div>
            <div class="footer" [hidden]="psnBaseInfoIfy.TABLE_CODE === 'person_file'">
                <button
                    [hidden]="psnBaseInfoIfy.TABLE_CODE === 'JBT'"
                    nz-button
                    nzType="primary"
                    style="margin-right: 10px"
                    (click)="psnBaseInfoIfy.evtSaveChildData()"
                    [disabled]="!isUsable"
                >
                    保存
                </button>
                <button [disabled]="!isUsable" nz-button nzType="primary" (click)="checkSalary()">
                    核定工资
                </button>
            </div>
        </div>
    </div>
</ng-template>
<!-- A01 -->
<ng-template #A01ChildTemp let-TABLE_CODE="TABLE_CODE" let-fields="fields" let-result="result">
    <table class="custom_table">
        <tbody>
            <ng-container *ngFor="let row of fields; index as i">
                <tr *ngIf="i % 3 === 0">
                    <ng-container *ngFor="let item of fields; index as j">
                        <ng-container *ngIf="j >= i && j < i + 3">
                            <td class="label" [attr.fileName]="item.TABLE_COLUMN_CODE">
                                {{ item.TABLE_COLUMN_NAME }}
                            </td>
                            <td class="value" [class.value_readly]="item.canEdit">
                                <ng-container
                                    *ngIf="
                                        item.TABLE_COLUMN_DICTIONARY_CODE;
                                        else elseGeneralTemplate
                                    "
                                >
                                    <ng-container *ngIf="item.canEdit; else editInputTemp">
                                        {{ result[item.TABLE_COLUMN_CODE + '_CN'] }}
                                    </ng-container>
                                    <ng-template #editInputTemp>
                                        <input
                                            [readOnly]="item.TABLE_COLUMN_DICTIONARY_CODE"
                                            [ngModel]="result[item.TABLE_COLUMN_CODE + '_CN']"
                                            (click)="psnBaseInfoIfy.evtClick($event, item, result)"
                                        />
                                    </ng-template>
                                </ng-container>
                                <ng-template #elseGeneralTemplate>
                                    <ng-container *ngIf="item.canEdit; else unDicCodeTemp">
                                        <ng-container *ngIf="item.TABLE_COLUMN_CODE !== 'A0157'">
                                            {{ result[item.TABLE_COLUMN_CODE] }}
                                        </ng-container>

                                        <ng-container *ngIf="item.TABLE_COLUMN_CODE === 'A0157'">
                                            {{ result[item.TABLE_COLUMN_CODE + '_CN'] }}
                                        </ng-container>
                                    </ng-container>
                                    <ng-template #unDicCodeTemp>
                                        <input
                                            [(ngModel)]="result[item.TABLE_COLUMN_CODE]"
                                            (click)="psnBaseInfoIfy.evtClick($event, item, result)"
                                            (blur)="psnBaseInfoIfy.evtBlur($event, item, result)"
                                        />
                                    </ng-template>
                                </ng-template>
                            </td>
                        </ng-container>
                    </ng-container>
                </tr>
            </ng-container>
        </tbody>
    </table>
</ng-template>
<!-- A01Child -->
<ng-template #tableChildTemp let-TABLE_CODE="TABLE_CODE" let-fields="fields" let-result="result">
    <table class="custom_table">
        <thead>
            <tr>
                <ng-container *ngFor="let item of fields">
                    <th class="label" [attr.fileName]="item.TABLE_COLUMN_CODE">
                        {{ item.TABLE_COLUMN_NAME }}
                    </th>
                </ng-container>
                <th *ngIf="isUsable">操作</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let row of result; let i = index">
                <td nzLeft="0px">{{ i + 1 }}</td>
                <ng-container *ngFor="let item of fields; index as j">
                    <td *ngIf="j > 0" class="value">
                        <ng-container
                            *ngIf="item.TABLE_COLUMN_DICTIONARY_CODE; else elseGeneralChildTemplate"
                        >
                            <input
                                [readOnly]="item.TABLE_COLUMN_DICTIONARY_CODE"
                                [(ngModel)]="row[item.TABLE_COLUMN_CODE + '_CN']"
                                (click)="psnBaseInfoIfy.evtClick($event, item, row)"
                            />
                        </ng-container>
                        <ng-template #elseGeneralChildTemplate>
                            <input
                                [(ngModel)]="row[item.TABLE_COLUMN_CODE]"
                                (blur)="psnBaseInfoIfy.evtBlur($event, item, row)"
                            />
                        </ng-template>
                    </td>
                </ng-container>
                <ng-container *ngIf="isUsable">
                    <td
                        *ngIf="
                            psnBaseInfoIfy.TABLE_CODE === 'GZ01' ||
                            psnBaseInfoIfy.TABLE_CODE === 'GZ02' ||
                            psnBaseInfoIfy.TABLE_CODE === 'GZ06' ||
                            psnBaseInfoIfy.TABLE_CODE === 'GZ09'
                        "
                    >
                        <a (click)="psnBaseInfoIfy.evtDeleteData(row)">删除</a>
                    </td>
                </ng-container>
            </tr>
        </tbody>
    </table>
</ng-template>

<!-- 代码型录入  -->
<dictionary-drawer
    [code]="codeListIfy.codeId"
    (textChange)="codeListIfy.evtTextChange($event)"
    [(value)]="codeListIfy.value"
    [(visible)]="codeListIfy.visible"
>
</dictionary-drawer>

<!-- 人员工资信息 -->
<ng-template #otherInfoTemplate>
    <div class="other" [class.full_screen]="isDownFullScreen">
        <div class="layout">
            <div class="header tabset_header">
                <div>
                    <nz-radio-group
                        [(ngModel)]="psnSalaryInfoIfy.TABLE_CODE"
                        (ngModelChange)="psnSalaryInfoIfy.evtTabChange($event)"
                        nzButtonStyle="solid"
                    >
                        <ng-container *ngFor="let item of psnSalaryInfoIfy.list">
                            <label nz-radio-button [nzValue]="item.TABLE_CODE">{{
                                item.TABLE_NAME
                            }}</label>
                        </ng-container>
                    </nz-radio-group>
                </div>

                <div class="tabset_extra">
                    <div class="arrows" (click)="evtUpDownArrows('down')">
                        <i class="fa fa-arrows-alt"></i>
                    </div>
                </div>
            </div>
            <div class="container">
                <ng-container *ngFor="let item of psnSalaryInfoIfy.list">
                    <div
                        class="view_scroll view_table"
                        [hidden]="!(item.TABLE_CODE === psnSalaryInfoIfy.TABLE_CODE)"
                    >
                        <ng-template
                            [ngTemplateOutlet]="item.PSN ? GZDA07Temp : GZTableTemp"
                            [ngTemplateOutletContext]="{
                                fields: item.fields,
                                result: item.PSN ? item.result : item.data
                            }"
                        ></ng-template>
                    </div>
                </ng-container>
            </div>

            <div [hidden]="psnSalaryInfoIfy.TABLE_CODE === 'GZDA07'" class="footer pagination">
                <nz-pagination
                    nzShowSizeChanger
                    [nzPageSizeOptions]="[5, 10, 20, 50]"
                    [nzTotal]="psnSalaryInfoIfy.pagination.total"
                    [(nzPageIndex)]="psnSalaryInfoIfy.pagination.pageIndex"
                    (nzPageIndexChange)="psnSalaryInfoIfy.pagination.pageChange()"
                    [(nzPageSize)]="psnSalaryInfoIfy.pagination.pageSize"
                    (nzPageSizeChange)="psnSalaryInfoIfy.pagination.pageChange(true)"
                ></nz-pagination>
            </div>
        </div>
    </div>
</ng-template>
<!-- GZDA07 -->
<ng-template #GZDA07Temp let-TABLE_CODE="TABLE_CODE" let-fields="fields" let-result="result">
    <table class="custom_table">
        <tbody>
            <ng-container *ngFor="let f of fields; let row = index">
                <tr *ngIf="row % 3 === 0">
                    <ng-container *ngFor="let item of fields; let column = index">
                        <ng-container *ngIf="column >= row && column < row + 3">
                            <td class="label" [attr.fileName]="item.TABLE_COLUMN_CODE">
                                {{ item.TABLE_COLUMN_NAME }}
                            </td>
                            <td class="value">
                                <ng-container
                                    *ngIf="
                                        item.TABLE_COLUMN_DICTIONARY_CODE;
                                        else elseGeneralTemplate
                                    "
                                >
                                    {{ result[item.TABLE_COLUMN_CODE + '_CN'] || '' }}
                                </ng-container>
                                <ng-template #elseGeneralTemplate>
                                    {{ result[item.TABLE_COLUMN_CODE] || '' }}
                                </ng-template>
                            </td>
                        </ng-container>
                    </ng-container>
                </tr>
            </ng-container>
        </tbody>
    </table>
</ng-template>
<!-- 除GZDA07之外的子集 -->
<ng-template #GZTableTemp let-TABLE_CODE="TABLE_CODE" let-fields="fields" let-result="result">
    <table class="custom_table">
        <thead>
            <tr>
                <ng-container *ngFor="let item of fields">
                    <th class="label" [attr.fileName]="item.TABLE_COLUMN_CODE">
                        {{ item.TABLE_COLUMN_NAME }}
                    </th>
                </ng-container>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let row of result; let i = index">
                <td nzLeft="0px">
                    {{
                        (psnSalaryInfoIfy.pagination.pageIndex - 1) *
                            psnSalaryInfoIfy.pagination.pageSize +
                            (i + 1)
                    }}
                </td>
                <ng-container *ngFor="let item of fields; index as j">
                    <td *ngIf="j > 0" class="value">
                        <ng-container
                            *ngIf="item.TABLE_COLUMN_DICTIONARY_CODE; else elseGZDA07ChildTemplate"
                        >
                            {{ row[item.TABLE_COLUMN_CODE + '_CN'] || '' }}
                        </ng-container>
                        <ng-template #elseGZDA07ChildTemplate>
                            {{ row[item.TABLE_COLUMN_CODE] || '' }}
                        </ng-template>
                    </td>
                </ng-container>
            </tr>
        </tbody>
    </table>
</ng-template>

<!-- 是否是教师护士、是否是义务教育、是否是特殊教育 -->
<t-is-teacher-table
    #isTeacherTableComponent
    [currentTableCode]="psnBaseInfoIfy.TABLE_CODE"
    [jobStepInfo]="jobStepInfo"
    [sign]="openEditDrawer.sign"
    [personKey]="this.personListIfy.selectedPsnData?.keyId"
    (isChange)="updateJBTorGZBS()"
></t-is-teacher-table>

<!-- 工龄情况 -->
<standing-change
    #StandingChangeComponent
    [personInf]="this.personListIfy.selectedPsnData.keyId"
    [jobStepInfo]="jobStepInfo"
    (isChange)="calculateA0134A($event)"
></standing-change>

<!-- 填报方向步骤: 上传人员附件材料 -->
<ng-template #personFileTemp>
    <div class="layout">
        <div class="container view_scroll">
            <div class="person_file_tbl">
                <div class="file_type_list">
                    <ng-container *ngFor="let data of operPersonFileIfy.data">
                        <div class="title">
                            <span class="must" *ngIf="data.isMustInput">*</span
                            >{{ data.annexName }}：
                        </div>
                        <div class="file_list">
                            <nz-upload
                                class="upload-list-inline"
                                nzMultiple
                                nzListType="picture"
                                [nzData]="data"
                                [(nzFileList)]="data.fileList"
                                [nzCustomRequest]="operPersonFileIfy.fileCustomRequest"
                                [nzRemove]="operPersonFileIfy.fileRemove"
                                [nzPreview]="operPersonFileIfy.preview"
                                [nzShowUploadList]="{ showRemoveIcon: isUsable }"
                                [nzShowButton]="isUsable"
                            >
                                <button nz-button><i nz-icon nzType="upload"></i>上传附件</button>
                            </nz-upload>
                        </div>
                    </ng-container>

                    <ng-container *ngIf="operPersonFileIfy.data.length === 0">
                        <div class="title">无可上传附件类别，请检查后台设置。</div>
                    </ng-container>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<!-- 人员附件列表抽屉 -->
<nz-drawer
    [nzVisible]="operPersonFileIfy.fileListIfy.visible"
    [nzTitle]="operPersonFileIfy.fileListIfy.title"
    [nzWidth]="operPersonFileIfy.fileListIfy.width"
    (nzOnClose)="operPersonFileIfy.fileListIfy.close()"
>
    <div class="drawer_area">
        <div class="container">
            <nz-upload
                nzMultiple
                [nzLimit]="5"
                nzListType="picture"
                [nzFileList]="operPersonFileIfy.fileListIfy.list"
                [nzRemove]="operPersonFileIfy.fileListIfy.fileRemove"
                [nzPreview]="operPersonFileIfy.fileListIfy.preview"
            >
            </nz-upload>
        </div>
    </div>
</nz-drawer>

<!-- 在线预览附件 -->
<gl-online-doc
    #onlineDocOverlayElement
    [fileList]="operPersonFileIfy.fileListIfy.list"
    [selectedIndex]="operPersonFileIfy.fileListIfy.selectedIndex"
></gl-online-doc>
