import { ExcelControlService } from './excel-control.service';
import {
    Component,
    OnInit,
    Input,
    ViewChildren,
    QueryList,
    ElementRef,
    ContentChild,
    TemplateRef,
} from '@angular/core';
import { FormAccessTypeEnum } from './enums/FormAccessTypeEnum';

@Component({
    // tslint:disable-next-line:component-selector
    selector: 'excel-control',
    templateUrl: './excel-control.component.html',
    styleUrls: ['./excel-control.component.scss'],
})
export class ExcelControlComponent implements OnInit {
    /**
     * 表册标识符
     */
    _permission: string;
    @Input() set permission(v) {
        if (!v) {
            return;
        }
        this._permission = v;
        this.tableRowTemplate = null;
        this.sheetIfy.list = [];
        setTimeout(() => {
            this.loadExcelInfo();
        }, 1);
    }
    get permission(): string {
        return this._permission;
    }

    /**
     * 表册参数
     */
    _params: any;
    @Input() set params(v) {
        if (!v || Object.keys(v).length === 0) {
            return;
        }
        this._params = v;
        const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
        if (sheet && sheet.isLoad) {
            this.loadSheetData();
        }
    }
    get params() {
        return this._params;
    }

    /**
     * 版本号
     */
    @Input() version = 1;

    /**
     * 是否预览模式（不取数）
     */
    @Input() isPreview = false;

    /**
     * 是否打印
     */
    @Input() isPrint = false;

    /**
     * 是否下载
     */
    @Input() isDown = false;

    /**
     * 自定义头部模板
     */
    @Input() diyHeaderTemplate: TemplateRef<void>;

    /**
     * 自定义格式化显示
     */
    @Input() formatConfig = {
        formatChar: null,
        formatConditionFN: null,
    };
    // @Input() formatConfig = {
    //     formatChar: '<b>%s</b>',
    //     formatConditionFN: v => v < 0,
    // };

    /**
     * 表册信息
     */
    formInfo;

    /**
     * sheet标签
     */
    sheetIfy = {
        list: [],
        selecedtIndex: 0,
        evtChange: event => {
            this.setExcelHTML();
        },
    };

    @ViewChildren('excelmultiMains') excelmultiMains: QueryList<ElementRef>;

    tableRowTemplate: HTMLTableRowElement;

    constructor(private service: ExcelControlService) {}

    ngOnInit() {}

    /**
     * 表册基本信息
     */
    private loadExcelInfo() {
        this.service.getFormData(this.permission, this.version).subscribe(result => {
            this.formInfo = result;
            this.loadExcelSheetList();
        });
    }

    /**
     * 加载Sheet标签
     */
    private loadExcelSheetList() {
        this.service.getExcelSheetList(this.formInfo.SYS_FORM_ID).subscribe(result => {
            this.sheetIfy.list = result.map((sheet, index) => {
                sheet.path = `assets/excels/${this.formInfo.FORM_NAME}_${index}.htm`;
                return sheet;
            });
            this.sheetIfy.evtChange(this.sheetIfy.selecedtIndex);
        });
    }

    /**
     * 加载sheet对应HTML
     */
    async setExcelHTML() {
        const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
        if (sheet.html) {
            this.loadFormConfigData();
            return;
        }
        sheet.html = await this.service.getExcelOfHTML(sheet.path);
        const childRef: HTMLElement = this.excelmultiMains.toArray()[this.sheetIfy.selecedtIndex]
            .nativeElement;
        if (childRef) {
            childRef.innerHTML = sheet.html;
            sheet.doc$ = childRef;
            sheet.table$ = sheet.doc$.querySelector('table');
            this.buildVirtualTable();
        }

        this.loadFormConfigData();
    }

    /**
     * 加载表册配置信息
     */
    loadFormConfigData() {
        const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
        this.service
            .getFormPageConfig({
                SYS_FORM_ID: this.formInfo.SYS_FORM_ID,
                FORM_CONFIG_PAGE_NO: this.sheetIfy.selecedtIndex,
            })
            .subscribe(result => {
                sheet.pageConfig = result;
                this.loadFormArea();
            });
    }

    /**
     * 加载表册区域
     */
    private loadFormArea() {
        const data = {
            FORM_AREA_FORM_ID: this.formInfo.SYS_FORM_ID,
            FORM_AREA_PAGE_NO: this.sheetIfy.selecedtIndex,
        };
        this.service.getAreaSettingList(data).subscribe(result => {
            const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
            sheet.area = result;
            sheet.isLoad = true;

            this.loadSheetData();
        });
    }

    /**
     * 加载表册数据
     */
    private loadSheetData() {
        if (!this.params || Object.keys(this.params).length === 0) {
            return;
        }
        const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
        this.service
            .getFormExecute({
                ...this.params,
                SYS_FORM_ID: this.formInfo.SYS_FORM_ID,
                FORM_CONFIG_PAGE_NO: this.sheetIfy.selecedtIndex,
            })
            .subscribe(result => {
                sheet.formExecute = result;
                this.initSheetResult();
            });
    }

    /**
     * 初始化sheet数据
     * 分离cell，table（区域）数据
     */
    private initSheetResult() {
        const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
        if (sheet.area.length > 0) {
            const areaData = [];
            sheet.area.forEach(item => {
                const { FORM_AREA_START_X, FORM_AREA_START_Y } = item;
                const key = `${item.FORM_AREA_PAGE_NO},${FORM_AREA_START_X},${FORM_AREA_START_Y}`;
                areaData.push(sheet.formExecute[key]);
                delete sheet.formExecute[key];
            });
            sheet.areaData = areaData;
            this.setSheetAreaData();
        }
        this.setSheetData();
    }

    /**
     * 设置sheet数据
     */
    private setSheetData() {
        const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
        // tslint:disable-next-line:forin
        for (const key in sheet.formExecute) {
            const [sheetIndex, x, y] = key.split(',');
            const config = sheet.pageConfig.find(v => v.startStr === key);
            if (!config) {
                continue;
            }
            let value = sheet.formExecute[key].value;
            if (typeof this.formatConfig.formatConditionFN === 'function') {
                if (this.formatConfig.formatConditionFN(value)) {
                    value = this.formatConfig.formatChar.replace('%s', value);
                }
            }
            switch (config.accessType) {
                case FormAccessTypeEnum.CHAR:
                    this.setCellValue(x, y, value);
                    break;
                case FormAccessTypeEnum.LIST:
                    break;
                case FormAccessTypeEnum.PHOTO:
                    this.setCellValue(
                        x,
                        y,
                        `<img width="98" height="121" src="api/gl-file-service/photo/${sheet.formExecute[key].value}" onerror="this.src = 'assets/images/wf/noPictureNoFun.png'"/>`
                    );
                    break;
            }
        }
    }

    /**
     * 设置sheet 区域数据
     */
    private setSheetAreaData() {
        const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
        // 遍历每个区域进行数据搬到
        sheet.area.forEach((item, index) => {
            const { FORM_AREA_START_X, FORM_AREA_START_Y, FORM_AREA_END_X, FORM_AREA_END_Y } = item;
            const list = sheet.pageConfig.filter(
                c =>
                    c.sheet === item.FORM_AREA_PAGE_NO &&
                    c.startX >= FORM_AREA_START_X &&
                    c.startY >= FORM_AREA_START_Y &&
                    c.endX <= FORM_AREA_END_X &&
                    c.endY <= FORM_AREA_END_Y
            );
            // 每个区域列表绑定数据
            this.setTableListData(item, list, sheet.areaData[index]);
        });
    }

    /**
     * 设置sheet每个区域的数据
     */
    private setTableListData(config, fileList, result) {
        let rowLine = config.FORM_AREA_DATA_ROW;
        // 处理自动增加行
        if (config.FORM_AREA_ADD_ROW) {
            // 自动增加行采用数据的实际行
            if (rowLine === -1) {
                rowLine = result.length;
            }

            const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
            const table: HTMLTableElement = sheet.table$;
            const table_body = table.lastChild;
            if (!this.tableRowTemplate) {
                this.tableRowTemplate = this.cloneRow(table, config.FORM_AREA_START_X);
            }
            // const len = table.rows.length;
            // for (let i = 0; i < len; i++) {
            //     if (i >= config.FORM_AREA_START_X) {
            //         table_body.removeChild(table_body.lastChild);
            //     }
            // }

            let rowIndex = 0;
            while (
                table_body.hasChildNodes() &&
                rowIndex !== config.FORM_AREA_START_X &&
                table.rows.length > config.FORM_AREA_START_X
            ) {
                if (table_body.lastChild) {
                    rowIndex = table_body.lastChild['rowIndex'];
                    table_body.removeChild(table_body.lastChild);
                }
            }

            if (rowLine < 1) {
                return;
            }
            for (let i = 1; i <= rowLine; i++) {
                const r = this.tableRowTemplate.cloneNode(true);
                [].forEach.call(this.tableRowTemplate.cells, (cell, y) => {
                    const rIndex = cell.getAttribute('r');
                    cell.setAttribute('r', parseInt(rIndex) + i);
                });
                table_body.appendChild(r);
            }
            this.buildVirtualTable();
        }

        // 不增加行，只绑定约定行
        // 自动增加行，只绑定数据实际行
        for (let index = 0; index < rowLine; index++) {
            const row = result[index];
            if (config.FORM_AREA_ORDER_COL > -1) {
                this.setCellValue(
                    config.FORM_AREA_START_X + index,
                    config.FORM_AREA_ORDER_COL,
                    index + 1
                );
            }
            for (const key in row) {
                if (row.hasOwnProperty(key)) {
                    const [sheetIndex, x, y] = key.split(',');
                    if (x && y) {
                        const _x = parseInt(x) + index;
                        const item = fileList.find(v => v.startStr === key);
                        if (item) {
                            this.setCellValue(_x, y, row[key].value);
                        }
                    }
                }
            }
        }
    }

    /**
     * 克隆行
     * @param table 表格
     * @param rowIndex 克隆源行
     */
    private cloneRow(table, rowIndex): HTMLTableRowElement {
        return table.rows[rowIndex].cloneNode(true) as HTMLTableRowElement;
    }

    /**
     * 构建虚拟非合并二维表
     */
    private buildVirtualTable() {
        const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
        const rowCount = this.getRowCount();
        const cellCount = this.getCellCount();
        sheet.virtualTable = Array(rowCount)
            .fill(null)
            .map(() => Array(cellCount).fill(null));

        const table: HTMLTableElement = sheet.table$;
        [].forEach.call(table.rows, (row, x) => {
            [].forEach.call(row.cells, (cell, y) => {
                const rowSpan = parseInt(cell.rowSpan);
                const colSpan = parseInt(cell.colSpan);

                const v_row = sheet.virtualTable[x];
                const absColIndex = v_row.indexOf(null);
                if (absColIndex >= 0) {
                    v_row[absColIndex] = {
                        isSource: true,
                        cell: cell,
                        rowIndex: x,
                        cellIndex: y,
                        // lockCell: x < this.fixRowNumber || absColIndex < this.fixColNumber,
                    };
                }

                cell.setAttribute('r', x);
                cell.setAttribute('c', absColIndex);

                for (let i = 0; i < rowSpan; i++) {
                    for (let j = 0; j < colSpan; j++) {
                        if (i === 0 && j === 0) {
                            continue;
                        }
                        sheet.virtualTable[x + i][absColIndex + j] = { isSource: false }; // 合并非源
                    }
                }
            });
        });
    }

    /**
     * 获得sheet最大行数
     */
    getRowCount() {
        const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
        const table: HTMLTableElement = sheet.table$;
        return table.rows.length;
    }

    /**
     * 获得sheet最大列数
     */
    getCellCount() {
        const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
        const table: HTMLTableElement = sheet.table$;
        return [].map
            .call(table.rows[0].cells, cell => Number(cell.colSpan))
            .reduce((p, c) => p + c);
    }

    /**
     * 获得单元格
     * @param rowIndex 行索引
     * @param cellIndex 列索引
     */
    getCell(rowIndex, cellIndex): HTMLTableDataCellElement {
        const sheet = this.sheetIfy.list[this.sheetIfy.selecedtIndex];
        // const table: HTMLTableElement = sheet.table$;
        // return table.rows[rowIndex].cells[cellIndex];
        return sheet.virtualTable[rowIndex][cellIndex].cell;
    }

    /**
     * 设置单元格值
     * @param rowIndex 行索引
     * @param cellIndex 列索引
     * @param value 值
     */
    setCellValue(rowIndex, cellIndex, value) {
        const td$ = this.getCell(rowIndex, cellIndex);
        td$.innerHTML = value;
    }

    /**
     * 下载表册
     */
    down() {
        this.service.downExcel({ ...this.params, SYS_FORM_ID: this.formInfo.SYS_FORM_ID });
    }
}
