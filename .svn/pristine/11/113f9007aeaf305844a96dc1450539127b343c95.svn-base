import {
    Component,
    OnInit,
    AfterViewInit,
    OnDestroy,
    ViewChild,
    ElementRef,
    ChangeDetectorRef,
} from '@angular/core';
import { ClientService } from 'app/master-page/client/client.service';
import { NzModalService } from 'ng-zorro-antd/modal';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzTableComponent } from 'ng-zorro-antd/table';
import { ActivatedRoute, Router } from '@angular/router';
import { CommonService } from 'app/util/common.service';
import { fromEvent, Subject } from 'rxjs';
import { debounceTime, distinctUntilChanged } from 'rxjs/operators';
import { WorkbenchService } from 'app/workflow/workbench/workbench.service';
import { JobStepStateEnum } from 'app/workflow/enums/JobStepStateEnum';

import { Base64 } from 'js-base64';
import { OrgTypeEnum } from 'app/entity/enums/OrgTypeEnum';
import { UserParameterTypeEnum } from 'app/entity/enums/UserParameterTypeEnum';
import { WorkflowService } from 'app/workflow/workflow.service';
import { SelectOrgDrawerComponent } from 'app/components/select-org/select-org-drawer/select-org-drawer.component';
import { WfTableHelper } from 'app/util/classes/wf-table-helper';
import { PersonCorrelService } from './person-correl.service';

@Component({
    selector: 'gl-person-correl',
    templateUrl: './person-correl.component.html',
    styleUrls: ['./person-correl.component.scss'],
})
export class PersonCorrelComponent implements OnInit, AfterViewInit {
    orgTypeEnum = OrgTypeEnum;
    /**
     * 当前账号信息
     */
    sessionUser = this.commonService.getUserLoginInfo();

    @ViewChild('operListElement', { static: false }) operListElement: ElementRef;
    /**
     * 业务按钮
     */
    operBtnListIfy = {
        data: [],
        list: [],
        moreList: [],
        evtloadOperPage: async item => {
            if (item.disabled) {
                return false;
            }
            if (item.SYSTEM_RESOURCE_WF_ID) {
                // 判断是否存在草稿
                this.operPendingIfy.data = await this.workbenchService
                    .selectByWfId(item.SYSTEM_RESOURCE_WF_ID)
                    .toPromise();
                if (this.operPendingIfy.data.length > 0) {
                    this.operPendingIfy.title = item.SYSTEM_RESOURCE_NAME;
                    this.operPendingIfy.operBtnInfo = item;
                    this.operPendingIfy.open();
                    return;
                }
                this.operNeedAgentIfy.loadNeedAgentList(item);
            }
        },
        /**
         * 跳转业务界面
         */
        _redirectOperPage: (wfId, params: any = {}) => {
            const url = `client/workflow/factory/${wfId}/${params.stepId || ''}`;
            params.redirect = this.router.url;
            if (!params.hasOwnProperty('jobStepState')) {
                params.jobStepState = JobStepStateEnum.PROCESSING;
            }
            const GL = Base64.encode(JSON.stringify(params));
            this.router.navigate([url], { queryParams: { GL } });
        },
    };

    /**
     * 可继续办理业务
     */
    operPendingIfy = {
        // 抽屉内容
        width: 560,
        visible: false,
        title: '可继续办理业务',
        close: () => {
            this.operPendingIfy.visible = false;
        },
        open: () => {
            this.operPendingIfy.visible = true;
        },

        data: [],
        operProcess: row => {
            const url = `client/workflow/factory/${row.wfId}/${row.stepId || ''}`;
            const params = <any>{
                ...row,
                redirect: this.router.url,
            };
            if (!params.hasOwnProperty('jobStepState')) {
                params.jobStepState = JobStepStateEnum.PROCESSING;
            }

            const GL = Base64.encode(JSON.stringify(params));
            this.router.navigate([url], { queryParams: { GL } });
        },
        loading: false,
        operBtnInfo: null,
        newOperStart: () => {
            this.operNeedAgentIfy.loadNeedAgentList(this.operPendingIfy.operBtnInfo);
        },
    };

    /**
     * 代管代为抽屉
     */
    operNeedAgentIfy = {
        // 抽屉内容
        width: 480,
        visible: false,
        title: '选择代管单位发起业务',
        close: () => {
            this.operNeedAgentIfy.visible = false;
        },
        open: () => {
            this.operNeedAgentIfy._init();
            this.operNeedAgentIfy.visible = true;
        },

        wfId: null,
        table: {
            data: [],
            pageSize: 15,
            selectedRow: null,
            evtSelectRow: row => {
                this.operNeedAgentIfy.table.selectedRow = row;
            },
        },

        _init: () => {
            this.operNeedAgentIfy.table.selectedRow = null;
            if (this.operNeedAgentIfy.table.data.length > 0) {
                return;
            }
            this.workbenchService.getAgentOrgList(this.sessionUser.userId).subscribe(result => {
                this.operNeedAgentIfy.table.data = result || [];
            });
        },
        loadNeedAgentList: async item => {
            this.operPendingIfy.loading = true;
            // 业务是否代管办理
            const result = await this.workbenchService
                .getWfMainData(item.SYSTEM_RESOURCE_WF_ID)
                .toPromise();
            this.operPendingIfy.loading = false;
            if (result.isNeedAgent) {
                this.operNeedAgentIfy.wfId = item.SYSTEM_RESOURCE_WF_ID;
                this.operNeedAgentIfy.open();
                return;
            }
            this.operBtnListIfy._redirectOperPage(item.SYSTEM_RESOURCE_WF_ID);
        },
        /**
         * 选中代管单位发业务
         */
        evtSelectUnit: () => {
            const row = this.operNeedAgentIfy.table.selectedRow;
            const params = { agentOrgId: row.UNIT_ID, agentOrgName: row.UNIT_NAME };
            this.operBtnListIfy._redirectOperPage(this.operNeedAgentIfy.wfId, params);
        },
    };

    /**
     * 头部功能
     */
    headhandleIfy = {
        evtQuery: () => {
            this.router.navigate(['client/complex-query/advanced-query']);
        },
        evtSelectUnit: () => {
            this.selectOrgDrawerElement.show();
        },

        headPermission: () => {
            // return this.listTypeOptionIfy.mode === ListTypeEnum.BASE
            //     ? 'person_list_fields'
            //     : 'person_list_salary_fields';
        },
        fieldsChange: () => {
            // this.listTypeOptionIfy.evtChange();
            // this.buildTableHeader(this.headhandleIfy.userParameterType(), event);
        },
        evtChange: () => {
            // this.personSalaryTableIfy.evtPageChange();
        },
        evtFieldsAdjust: () => {
            // this.headFieldsAdjustElement.show();
        },

        orderParams: null,
        evtPersonOrder: () => {
            // if (!this.selectUnitIfy.selectedNode.ORG_B01_ID) {
            //     return;
            // }
            // this.headhandleIfy.orderParams = {
            //     ORG_B01_ID: this.selectUnitIfy.selectedNode.ORG_B01_ID,
            //     A0103: this.pClassTabIfy.value,
            // };
            // this.personOrderElement.show();
        },

        evtDataVerify: () => {
            // this.personVerifyElement.show();
        },
        evtDown: () => {
            // let personArr = [];
            // personArr = this.personSalaryTableIfy.result
            //     .filter(item => {
            //         return this.personSalaryTableIfy.mapOfCheckedId[
            //             item[`${this.tableHelper.getTableCode('A01')}_ID`]
            //         ];
            //     })
            //     .map(item => item[`${this.tableHelper.getTableCode('A01')}_ID`]);
            // const data = {
            //     ...this.getCommonHttpParams(),
            //     DATA_PERSON_A01_ID_LIST: personArr,
            // };
            // this.service.outputExcelByOrgId(data);
        },
    };

    @ViewChild('selectOrgDrawerElement', { static: false })
    selectOrgDrawerElement: SelectOrgDrawerComponent;
    /**
     * 选中单位
     */
    selectUnitIfy = {
        level: false,
        selectedNode: <any>{},
        evtLevelChange: () => {},
        affirmSelectedChange: event => {},
    };

    /**
     * 人员查询条件
     */
    personConditionIfy = {
        /**
         * 人员库
         */
        personLibTab: {
            codeId: 'C',
            nzShowPagination: true,
            value: null,
            nzType: 'line',
            selectedIndex: 0,
            list: [],
            loadList: () => {
                this.service
                    .getCodeList(this.personConditionIfy.personLibTab.codeId)
                    .subscribe(result => {
                        this.personConditionIfy.personLibTab.list = result;
                        const [first] = result;
                        this.personConditionIfy.personLibTab.value = first.value;
                    });
            },
            onSelectChange: ({ index }) => {
                // const tab = this.psnConditionIfy.personLibTab;
                // tab.value = tab.data[index].value;
                // this.listTypeOption.loadPageData();
            },
        },

        /**
         * 管理类别
         */
        adminCategor: {
            codeId: 'XZ46',
            value: '-1',
            list: [{ label: '全部', value: '-1' }],
            loadList: () => {
                this.service
                    .getCodeList(this.personConditionIfy.adminCategor.codeId)
                    .subscribe(result => {
                        this.personConditionIfy.adminCategor.list = this.personConditionIfy.adminCategor.list.concat(
                            result
                        );
                    });
            },
            evtChange: () => {
                // this.listTypeOption.loadPageData();
            },
        },

        /**
         * 统计类别
         */
        unitType: {
            list: [
                { label: '按任职单位', value: '01' },
                { label: '按统计单位', value: '02' },
            ],
            value: '01',
            evtChange: () => {
                // this.listTypeOption.loadPageData();
            },
        },

        evtInit: () => {
            this.personConditionIfy.personLibTab.loadList();
            this.personConditionIfy.adminCategor.loadList();
            // 默认选中第一个选项
            // const [_unitType] = this.psnConditionIfy.unitType.list;
            // this.psnConditionIfy.unitType.value = _unitType.value;
        },
    };

    // 人员表格
    @ViewChild('personTableDataElement', { static: false })
    personTableDataElement: NzTableComponent;
    personTableIfy = {
        result: [],
        pageIndex: 1,
        pageSize: 30,
        totalCount: 0,
        BufferPx: 500,
        scroll: { x: '2000px', y: '500px' },
        loading: false,

        selectedRowIndex: -1,
        filterFields: <any>{
            list: [
                { field: 'A0151', codeId: 'STATUS' },
                { field: 'A0104', codeId: 'CAX' },
                { field: 'A0117', codeId: 'GB3304' },
                { field: 'A0141', codeId: 'GB4762' },
                { field: 'A01R02', codeId: 'BB003' },
                { field: 'A01R01E', codeId: 'BB003' },
            ],
            result: {},
            loadCodeIdsList: () => {
                /**
                 * 构造表格列赛选器 查询内容
                 */
                const codeIds = this.personTableIfy.filterFields.list.map(item => {
                    this.personTableIfy.filterFields[item.field] = [];
                    return item.codeId;
                });
                this.service.selectListByCodes(codeIds).subscribe(result => {
                    this.personTableIfy.filterFields.list.forEach(item => {
                        this.personTableIfy.filterFields[item.field] = result[item.codeId].map(
                            item => {
                                return {
                                    ...item,
                                    label: item.DICTIONARY_ITEM_NAME,
                                    text: item.DICTIONARY_ITEM_NAME,
                                    value: item.DICTIONARY_ITEM_CODE,
                                };
                            }
                        );
                    });
                });
            },
            // 表格头部筛选条件
            evtChange: (data, field) => {
                this.personTableIfy.filterFields.result[field] = data;
                this.personTableIfy.evtPageChange(true);
            },
        },
        evtViewDetails: data => {
            globalThis.event.preventDefault();
            const GL = Base64.encode(
                JSON.stringify({
                    ID: data.DATA_PERSON_A01_ID,
                })
            );
            // this.router.navigate(['personal-details', { GL }], { relativeTo: this.activatedRoute });
            const url = `irregularity/form-page;GL=${GL}`;
            // window.winAppointFormDlg = window.open(url, 'appoint-form');
            // if (window.winAppointFormDlg && window.winAppointFormDlg.closed) {
            //     window.winAppointFormDlg.focus();
            // }
        },

        allChecked: false,
        checkList: [],
        evtCheckAll: (value: boolean) => {
            this.personTableIfy.result.forEach(row => (row.checked = value));
            this.personTableIfy._getCheckList();
        },
        evtCheckRow: row => {
            this.personTableIfy._getCheckList();
        },
        _getCheckList: () => {
            this.personTableIfy.checkList = this.personTableIfy.result.filter(row => row.checked);
        },

        _evtReset: () => {
            this.personTableIfy.result = [];
            this.personTableIfy.totalCount = 0;
            this.personTableIfy.pageIndex = 1;
        },
        evtPageChange: (reset: boolean = false, isSelected: boolean = false) => {
            if (reset) {
                this.personTableIfy._evtReset();
            }
            this.personTableIfy.allChecked = false;
            if (!isSelected) {
                this.personTableIfy.selectedRowIndex = -1;
            }
            const data = this.getCommonCondtion();
            this.personTableIfy.loading = true;
            // const mode = this.listTypeOption.mode;
            // const setId = mode === this.listTypeEnum.TABLE ? 'a01' : 'a01photo';
            this.service.getPersonDataPage(data).subscribe(data => {
                this.personTableIfy.loading = false;
                if (data.totalCount === 0) {
                    data.totalCount = this.personTableIfy.totalCount;
                }
                this.personTableIfy.result = data.result;
                this.cdr.detectChanges();
                // 是否选中行
                if (isSelected) {
                    this.personTableDataElement.cdkVirtualScrollViewport.scrollToIndex(
                        this.personTableIfy.selectedRowIndex
                    );
                } else {
                    this.personTableDataElement.cdkVirtualScrollViewport.scrollToIndex(0);
                }
            });
        },

        evtSelectorRow: index => {
            this.personTableIfy.selectedRowIndex = index;
        },

        // 人员查询
        find: {
            list: [],
            keyword: null,
            evtOpenChange: status => {
                if (status) {
                    this.personTableIfy.find.keyword = null;
                }
            },
            evtOnSearch: (keyword: string) => {
                // if (keyword) {
                //     const data = this.getCommonCondtion({
                //         A0101: keyword.trim(),
                //     });
                //     this.service
                //         .queryPersonList(data)
                //         .subscribe(result => (this.personTableIfy.find.list = result));
                // }
            },
            evtChange: value => {
                // if (value === null) {
                //     return;
                // }
                // const data = this.getCommonCondtion({
                //     DATA_PERSON_A01_ID: value,
                // });
                // this.service.queryPersonRowNumber(data).subscribe(num => {
                //     // tslint:disable-next-line:radix
                //     this.personTableIfy.pageIndex =
                //         // tslint:disable-next-line:radix
                //         parseInt((num / this.personTableIfy.pageSize).toString()) + 1;
                //     this.personTableIfy.selectedRowIndex = num % this.personTableIfy.pageSize;
                //     this.personTableIfy.evtPageChange(false, true);
                // });
            },
        },
    };

    constructor(
        private clientService: ClientService,
        private service: PersonCorrelService,
        private router: Router,
        private activatedRoute: ActivatedRoute,
        private commonService: CommonService,
        private cdr: ChangeDetectorRef,
        private workbenchService: WorkbenchService,
        private workflowService: WorkflowService,
        private tableHelper: WfTableHelper
    ) {}

    ngOnInit(): void {
        // 默认设置选中单位
        this.selectUnitIfy.selectedNode.ORG_NAME = this.sessionUser.unitName;
        this.selectUnitIfy.selectedNode.ORG_TYPE = OrgTypeEnum.UNIT;
        this.selectUnitIfy.selectedNode.ORG_B01_ID = this.sessionUser.unitId;

        this.loadUserOperAuth();
        this.personConditionIfy.evtInit();
        this.personTableIfy.filterFields.loadCodeIdsList();
    }

    ngAfterViewInit(): void {
        /**
         * 创建面包屑导航
         */
        this.clientService.buildBreadCrumb([
            {
                type: 'home',
            },
            {
                type: 'text',
                text: '人员管理',
            },
            {
                type: 'text',
                text: '业务办理',
            },
        ]);

        // 计算表格虚拟滚动宽高
        fromEvent(window, 'resize')
            .pipe(debounceTime(300))
            .subscribe(() => {
                this.setOperListBtn();
            });

        this.personTableIfy.evtPageChange();
    }

    /**
     * 加载按钮（业务）权限
     */
    loadUserOperAuth() {
        /**
         * 获取账号权限
         */
        this.activatedRoute.data.subscribe(async (data: { tag: string }) => {
            const menus = this.commonService.getNavigeList();
            const menu = menus.find(item => item.SYSTEM_RESOURCE_GUARD_ID === data.tag);
            if (menu) {
                const authWfId = await this.workbenchService.getAuthWfId();
                this.operBtnListIfy.data = menus
                    .filter(item => item.SYS_PARENT === menu.SYSTEM_RESOURCE_TREE_ID)
                    .map(item => {
                        item.disabled = !(
                            authWfId[item.SYSTEM_RESOURCE_WF_ID] &&
                            authWfId[item.SYSTEM_RESOURCE_WF_ID].START
                        );
                        return item;
                    });
                this.cdr.detectChanges();
                this.setOperListBtn();
            }
        });
    }

    /**
     * 设置业务按钮
     */
    setOperListBtn() {
        this.operBtnListIfy.list = [];
        this.operBtnListIfy.moreList = [];
        const el = this.operListElement.nativeElement;
        const btnsEl = el.querySelectorAll('button');

        let width = 0;
        btnsEl.forEach((btn, index) => {
            width += btn.offsetWidth + 30;
            if (width >= el.offsetWidth - 110) {
                this.operBtnListIfy.moreList.push(this.operBtnListIfy.data[index]);
            } else {
                this.operBtnListIfy.list.push(this.operBtnListIfy.data[index]);
            }
        });
        this.operBtnListIfy.list = [...this.operBtnListIfy.list];
        this.operBtnListIfy.moreList = [...this.operBtnListIfy.moreList];

        this.cdr.detectChanges();
    }

    /**
     * 获取人员查询条件
     */
    private getCommonCondtion(customOption = {}) {
        const data = Object.assign(
            {
                DATA_UNIT_ORG_ID: this.selectUnitIfy.selectedNode.key,
                ORG_TYPE: this.selectUnitIfy.selectedNode.nodeType,
                ORG_B01_ID: this.selectUnitIfy.selectedNode.unitId,
                $TREE_INCLUDE_LOWER_LEVEL$: this.selectUnitIfy.selectedNode.level,
                UNIT_TYPE: this.personConditionIfy.unitType.value,
                A0103: this.personConditionIfy.personLibTab.value,
                $PAGE_INDEX$: this.personTableIfy.pageIndex,
                $PAGE_SIZE$: this.personTableIfy.pageSize,
                $FILTER_CONDITION$: this.personTableIfy.filterFields.result,
            },
            customOption
        );
        return data;
    }
}
